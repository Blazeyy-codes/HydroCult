/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All data is
 * private and belongs to a specific user. Access is granted only if the requesting
 * user's authenticated UID matches the user ID in the document path.
 *
 * Data Structure: The data is organized hierarchically under a top-level `users`
 * collection. All user-specific data are stored in subcollections directly under
 * that user's document (`/users/{userId}`). This structure is key to the security model.
 *
 * Key Security Decisions:
 * - Strict Ownership: A user can only read or write their own data.
 * - No User Enumeration: Listing all users is disallowed.
 * - Path-Based Security: Authorization relies on the `{userId}` wildcard.
 * - Relational Integrity: On create, rules verify the `userId` field matches the
 *   path. On update, this field is immutable.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Validates that a document in a user subcollection has a `userId` field
     * that matches the user from the path, ensuring relational integrity on create.
     */
    function isValidSubcollectionCreate(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * Enforces immutability of the subcollection document's `userId` field during updates.
     */
    function isSubcollectionOwnerImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    match /users/{userId} {
      // User can read and write their own profile document
      allow read, write: if isOwner(userId);
      
      // Disallow listing all users for security
      allow list: if false;

      /**
       * Generic rule for all user-specific subcollections.
       * This single rule covers goals, logs, reminders, etc., enforcing
       * strict ownership for all operations.
       */
      match /{subcollection}/{docId} {
        // Individual document access is granted if the user owns the parent document.
        allow get, delete: if isOwner(userId);
        
        // Listing documents is only allowed if the query is explicitly filtered
        // to the owner's user ID. This is a critical security pattern that
        // guarantees the query cannot access another user's data.
        allow list: if isOwner(userId) && request.query.resource.__name__.split('/')[3] == userId;
        
        // Creating a document is allowed if the user is the owner and the new
        // document contains their correct userId.
        allow create: if isOwner(userId) && isValidSubcollectionCreate(userId);

        // Updating a document is allowed if the user is the owner and they are not
        // attempting to change the document's original userId.
        allow update: if isOwner(userId) && isSubcollectionOwnerImmutable();
      }
    }
  }
}
